#!/bin/bash
set -e

echo "ğŸ”„ Aguardando dependÃªncias..."

# Espera o PostgreSQL estar pronto
until pg_isready -h postgres -p 5432 -U postgres > /dev/null 2>&1; do
  echo "â³ PostgreSQL nÃ£o estÃ¡ pronto ainda - aguardando..."
  sleep 2
done

echo "âœ… PostgreSQL estÃ¡ pronto!"

# Espera o Redis estar pronto
until redis-cli -h redis ping > /dev/null 2>&1; do
  echo "â³ Redis nÃ£o estÃ¡ pronto ainda - aguardando..."
  sleep 2
done

echo "âœ… Redis estÃ¡ pronto!"

# Espera o Auth Service estar pronto
echo "â³ Aguardando Auth Service..."
until curl -sf http://auth-service:3000/up > /dev/null 2>&1; do
  sleep 3
done
echo "âœ… Auth Service estÃ¡ pronto!"

# Remove pid antigo se existir
rm -rf tmp/pids/server.pid

# Instala dependÃªncias
echo "ğŸ“¦ Instalando dependÃªncias..."
bundle install --quiet

# Cria o banco se nÃ£o existir e executa migrations
echo "ğŸ—„ï¸ Configurando banco de dados..."
bundle exec rails db:prepare

echo "ğŸš€ Iniciando Vite + Rails..."
exec "$@"
