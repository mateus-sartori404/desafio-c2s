#!/bin/bash
set -e

echo "ğŸ”„ Aguardando PostgreSQL e Redis..."

# Espera o PostgreSQL estar pronto
until pg_isready -h postgres -p 5432 -U postgres > /dev/null 2>&1; do
  echo "â³ PostgreSQL nÃ£o estÃ¡ pronto ainda - aguardando..."
  sleep 2
done

echo "âœ… PostgreSQL estÃ¡ pronto!"

# Espera o Redis estar pronto
until redis-cli -h redis ping > /dev/null 2>&1; do
  echo "â³ Redis nÃ£o estÃ¡ pronto ainda - aguardando..."
  sleep 2
done

echo "âœ… Redis estÃ¡ pronto!"

# Remove pid antigo se existir
rm -rf tmp/pids/server.pid

# Instala dependÃªncias
echo "ğŸ“¦ Instalando dependÃªncias..."
bundle install --quiet

# Cria o banco se nÃ£o existir e executa migrations
echo "ğŸ—„ï¸ Configurando banco de dados..."
bundle exec rails db:prepare

# Inicia Sidekiq em background
echo "âš™ï¸ Iniciando Sidekiq..."
bundle exec sidekiq &

echo "ğŸš€ Iniciando servidor Rails..."
exec "$@"
